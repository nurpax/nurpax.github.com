<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <title>nurpax.github.com blog</title>
    <link href="http://nurpax.github.com/rss.xml" rel="self" />
    <link href="http://nurpax.github.com" />
    <id>http://nurpax.github.com/rss.xml</id>
    <author>
        <name>Janne Hellsten</name>
        <email>jjhellst@gmail.com</email>
    </author>
    <updated>2018-05-28T00:00:00Z</updated>
    <entry>
    <title>Handy command-line incantations</title>
    <link href="http://nurpax.github.com/posts/2018-05-28-handy-command-line-incantations.html" />
    <id>http://nurpax.github.com/posts/2018-05-28-handy-command-line-incantations.html</id>
    <published>2018-05-28T00:00:00Z</published>
    <updated>2018-05-28T00:00:00Z</updated>
    <summary type="html"><![CDATA[<p>Just some command line copy&amp;pastes that I always tend to forget. Mainly ImageMagick and ffmpeg.</p>
<h2 id="image-files">Image files</h2>
<p>View image width, height &amp; format:</p>
<pre><code>identify &lt;imagefile&gt;</code></pre>
<p>Make a .gif anim from a collection of image files:</p>
<pre><code>convert -loop 0 -delay 300 image1.png image2.png image3.png result.gif</code></pre>
<p>Resize an image with point-sampling while NOT preserving aspect-ratio (ImageMagick forces original aspect ratio without warning):</p>
<pre><code>convert input.png -sample 640x200! output.png</code></pre>
<p>Crop the input image and then make a .gif (<code>+repage</code> is required to actually crop the output image dimensions too):</p>
<pre><code># 104x30 is the size of the crop rectangle
# +62+22 is an offset to the top/left corner of the crop area
convert -crop 104x30+62+22 +repage -loop 0 -delay 300 image?.png result.gif</code></pre>
<h2 id="video-files">Video files</h2>
<p>View video file format details:</p>
<pre><code>ffprobe &lt;videofile&gt;</code></pre>
<p>Convert a VICE video capture .avi (in DivX format) to MP4:</p>
<pre><code>ffmpeg -i screencap.avi -c:v libx264 -crf 19 -preset slow -c:a libvo_aacenc -b:a 192k -ac 2 out.mp4</code></pre>]]></summary>
</entry>
<entry>
    <title>BINTRIS C64 title screen implementation (series part 3)</title>
    <link href="http://nurpax.github.com/posts/2018-05-27-bintris-on-c64-part-3.html" />
    <id>http://nurpax.github.com/posts/2018-05-27-bintris-on-c64-part-3.html</id>
    <published>2018-05-27T00:00:00Z</published>
    <updated>2018-05-27T00:00:00Z</updated>
    <summary type="html"><![CDATA[<p>(Looking for the BINTRIS C64 disk image? Find it <a href="/posts/2018-05-21-bintris-on-c64-part-2.html">here</a>.)</p>
<p>This blog post discusses the implementation of the BINTRIS C64 title screen.</p>
<p>The title screen consists of a multicolor bitmap at the top and a text mode scroller at the bottom. Here’s how it looks like:</p>
<div class="youtube">
<iframe class="video" src="https://www.youtube.com/embed/akaQcBNG9TE?rel=0&amp;controls=1&amp;showinfo=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen>
</iframe>
</div>
<p>This is a pretty standard text mode scroller: use the horizontal scroll register <code>$d016</code> for 0-7 pixel shifting. When you reach pixel offset 7, reset to pixel offset 0 and move the whole character row left by one character (8 pixels). Additionally, the scroller text is colored with raster bars.</p>
<p>But wait a minute.. The screen is in multicolor bitmap mode. How can we use a <em>text mode</em> scroller at the bottom? Fortunately it’s pretty easy to mix bitmap and text mode within a single frame. Just switch to text-mode right before raster beam reaches the scroller, and switch back to bitmap mode once the raster beam is past it.</p>
<p>The below animation illustrates how the raster IRQs trigger:</p>
<p><?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
    "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="100%" height="100%" viewBox="0 0 716 539"><style>text { font-family: "arial";}

#rasterbeam {
  animation-name: rasterline;
  animation-duration: 4s;
  animation-iteration-count: infinite;
  animation-timing-function: linear;
}
@keyframes rasterline {
  from { transform: translateY(26.0px); }
  to { transform: translateY(506.0px);  }
}
#hilite1 {
  animation-name: hilite1;
  animation-duration: 4s;
  animation-iteration-count: infinite;
  animation-timing-function: linear;
  transform-origin: center;
  transform-box: fill-box;
}
@keyframes hilite1 {
  0% { opacity:0; }
  6.25% { opacity:0; }
  6.26% { opacity:1; }
  16.25% { opacity:0; }
  100% { opacity:0; }
}

#hilite2 {
  animation-name: hilite2;
  animation-duration: 4s;
  animation-iteration-count: infinite;
  animation-timing-function: linear;
  transform-origin: center;
  transform-box: fill-box;
}
@keyframes hilite2 {
  0% { opacity:0; }
  86.666664% { opacity:0; }
  86.67667% { opacity:1; }
  96.666664% { opacity:0; }
  100% { opacity:0; }
}

#hilite3 {
  animation-name: hilite3;
  animation-duration: 4s;
  animation-iteration-count: infinite;
  animation-timing-function: linear;
  transform-origin: center;
  transform-box: fill-box;
}
@keyframes hilite3 {
  0% { opacity:0; }
  88.333336% { opacity:0; }
  88.34334% { opacity:1; }
  98.333336% { opacity:0; }
  100% { opacity:0; }
}

</style><g><image width="716.0" height="539.0" xlink:href="/images/bintris/titlescreen_for_blog.png" /><rect width="748.75" height="2.0" x="-16.875" y="56.0" fill="#008d46" /><rect width="748.75" height="2.0" x="-16.875" y="442.0" fill="#cf4600" /><rect width="748.75" height="2.0" x="-16.875" y="450.0" fill="#0046cf" /><rect width="748.75" height="2.0" x="-16.875" y="0.0" id="rasterbeam" fill="#ffffff" opacity="0.7" /></g><g><g id="title"><rect width="14.0" height="14.0" x="148.0" y="508.0" fill="#008d46" /><text x="167.0" y="521.0" fill="white">bitmap mode</text><rect width="130.0" height="23.0" x="145.0" y="504.0" fill="#fff" id="hilite1" /></g><g id="title"><rect width="14.0" height="14.0" x="298.0" y="508.0" fill="#cf4600" /><text x="317.0" y="521.0" fill="white">text mode</text><rect width="130.0" height="23.0" x="295.0" y="504.0" fill="#fff" id="hilite2" /></g><g id="title"><rect width="14.0" height="14.0" x="433.0" y="508.0" fill="#0046cf" /><text x="452.0" y="521.0" fill="white">raster bar</text><rect width="130.0" height="23.0" x="430.0" y="504.0" fill="#fff" id="hilite3" /></g></g></svg></p>
<p>In summary:</p>
<ul>
<li>Line 16 (<code>irq0</code>): set multicolor bitmap mode, move character row left by one character if <code>framecount&amp;7==0</code>.</li>
<li>Line 238 (<code>irq1</code>): switch to text mode, set horizontal scroll based on <code>framecount</code> bits 0-2</li>
<li>Line 241 (<code>irq2</code>): raster bars (using the <a href="http://codebase64.org/doku.php?id=base:double_irq_explained">double IRQ trick</a> for stable raster), loop back to Line 16</li>
</ul>
<p>And the same in assembly:</p>
<pre><code>.const irq0line = 16
.const textmodeswitchline = 50+200-12
.const rastercolorline = 50+200-9

framecount: .byte 0     // increased at the beginning of each frame

// Macro to save&amp;restore registers and setup the next routine in the
// raster IRQ chain.
.macro irq_start(end_lbl) {
    sta end_lbl-6
    stx end_lbl-4
    sty end_lbl-2
}

.macro irq_end(next, line) {
    :EndIRQ(next, line, false)
    lda #$00
    ldx #$00
    ldy #$00
    rti
}


irq0: {
    irq_start(end)

    inc framecount

    // Set screen mode
    lda #$3b // bitmap mode
    sta $d011
    lda #$18 // multicolor
    sta $d016
    // screen memory ptr
    lda #$18
    sta $d018

    jsr scroller_update_char_row

    irq_end(irq1, textmodeswitchline)
end:
    rti
}

irq1: {
    irq_start(end)

    lda #$1b        // screen on, text mode
    sta $d011

    lda framecount
    and #7
    eor #7 // xor bits 0-2 and leave bit 3 zero for 38 column mode
    sta $d016

    lda #$10 // bank + $0400
    sta $d018

    irq_end(irq2, rastercolorline)
end:
}

// Stable raster IRQ for color bars
irq2: {
    double_irq(end, irq3)

irq3:
    txs

    // Wait exactly 9 * (2+3) cycles so that the raster line is in the border
    ldx #$09
    dex
    bne *-1

    // First line is a bad line so we have only 23 cycles!
    lda colors1+0           // 4 cycles
    sta $d021               // 4 cycles
    .for (var i = 0; i &lt; 6; i++) {
        nop
    }
    bit $fe

    // Next 7 lines are normal lines, so 63 cycles per color change
    ldx #$01
!:
    lda colors1,x           // 4 cycles
    sta $d021               // 4 cycles
    .for (var i = 0; i &lt; (63-15)/2; i++) {
        nop
    }
    inx                     // 2
    cpx #colorend-colors1   // 2
    bne !-                  // 3

    lda #0
    sta $d021

    irq_end(irq0, irq0line)
end:
}</code></pre>
<p>I put up a full stand-alone version of this <a href="https://github.com/nurpax/c64-samples/tree/master/text-scroller">on github</a> – this should compile on KickAssembler. It’s a slightly cleaned up version of the BINTRIS titlescreen. For some historical reason I used VIC bank 1 instead of the default and made screen RAM reside at <code>$4400</code> instead of <code>$0400</code>. This can make the source a bit harder to follow.</p>
<h2 id="next-in-series">Next in series</h2>
<p>The next post will discuss how the main BINTRIS game screen is rendered.</p>]]></summary>
</entry>
<entry>
    <title>BINTRIS on the C64 has been released! (series part 2)</title>
    <link href="http://nurpax.github.com/posts/2018-05-21-bintris-on-c64-part-2.html" />
    <id>http://nurpax.github.com/posts/2018-05-21-bintris-on-c64-part-2.html</id>
    <published>2018-05-21T00:00:00Z</published>
    <updated>2018-05-21T00:00:00Z</updated>
    <summary type="html"><![CDATA[<div class="screenshotMax">
<p><img src="/images/bintris_titlescreen.png" title="BINTRIS" /></p>
</div>
<p>The Commodore 64 version of <a href="http://nurpax.com/bintris">BINTRIS</a> has been released!</p>
<p>Download the latest BINTRIS disk image: <a href="/files/bintris-2018-05-22.d64">bintris-2018-05-22.d64</a></p>
<p>(Originally <a href="http://csdb.dk/release/index.php?id=164874">released on CSDb</a> but further updates will be posted here on the blog.)</p>
<p>Here’s a quick VICE video cap (real hardware capture is coming online very soon):</p>
<div class="youtube">
<iframe class="video" src="https://www.youtube.com/embed/XRdg8u9umHo?rel=0&amp;controls=1&amp;showinfo=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen>
</iframe>
</div>
<p>Here’s the game objective in a nutshell:</p>
<div class="screenshotMax">
<p><img src="/images/bintris_how_to_play2.png" title="BINTRIS HOWTO PLAY" /></p>
</div>
<h2 id="next-in-series">Next in series</h2>
<p>The next post will discuss how the title screen mixes multicolor bitmap mode (the BINTRIS image) and text mode (the scroller).</p>]]></summary>
</entry>
<entry>
    <title>BINTRIS on the C64 (series part 1)</title>
    <link href="http://nurpax.github.com/posts/2018-05-19-bintris-on-c64-part-1.html" />
    <id>http://nurpax.github.com/posts/2018-05-19-bintris-on-c64-part-1.html</id>
    <published>2018-05-18T00:00:00Z</published>
    <updated>2018-05-18T00:00:00Z</updated>
    <summary type="html"><![CDATA[<h2 id="introduction">Introduction</h2>
<p>This is the first part of a blog series on making a small game called <a href="http://nurpax.com/bintris">BINTRIS</a> for the Commodore 64.</p>
<p>Here are a some of the topics I plan to cover in the series:</p>
<ul>
<li>Tooling</li>
<li>Sprite multiplexing</li>
<li>Mixed text and bitmap mode display</li>
<li>Vertical raster scroll and flexible line distance (FLD)</li>
<li>A line-by-line sprite sine-wave animation</li>
<li>SID sound effects</li>
</ul>
<p>As most of these are well-documented on the internet, my posts won’t be full-blown tutorials but rather examples of how to apply the above techniques in a game. I’ll start this series by covering tools.</p>
<h2 id="bintris">BINTRIS</h2>
<p>BINTRIS is a puzzle game that plays a little like Tetris but using binary numbers. Here’s a little gameplay video:</p>
<div class="youtube">
<iframe class="video" src="https://www.youtube.com/embed/RSAlFunPlYI?rel=0&amp;controls=0&amp;showinfo=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen>
</iframe>
</div>
<p>The idea is that each row is a binary number (black is zero, white is one) and you need to build rows that match the numbers listed below the DECIMAL heading.</p>
<p>Here’s a little teaser showcasing the readme.prg file from the bintris disk image:</p>
<div class="youtube">
<iframe class="video" src="https://www.youtube.com/embed/AYDKdRmlxFs?rel=0&amp;controls=0&amp;showinfo=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen>
</iframe>
</div>
<p>The game will be released any day now – I’ll update this post with a download link when it’s out. I’ll also post some more videos once I have the final version captured on real hardware.</p>
<h2 id="how-to-develop-for-the-c64">How to develop for the C64</h2>
<p>Probably the best choice for developing for the C64 is to use an emulator. I went with <a href="vice">VICE</a>.</p>
<p>I used <a href="kickass">KickAssembler</a> for compiling my assembly code. Its macro support is some seriously good stuff – I wish I had something like this when I used to work on PC demos.</p>
<p>For editing and compiling 6510 assembly source, I ended up going with the <a href="https://packagecontrol.io/packages/Kick%20Assembler%20(C64)">Sublime Text 3 and KickAssembler package</a>. This sets up your editor such that you can just press F7 and it will compile and run your code on VICE. It also supports building a debug version of your binary that allows setting breakpoints to break into the VICE monitor (read: debugger). The monitor can be remotely accessed with telnet from your host machine. Editing monitor commands on your host makes things like copy &amp; paste easier.</p>
<p>I had some problems with the VICE emulator though. For example, sound is pretty buggy on my MacBook Pro and sometimes buggy even on Windows 10. I also couldn’t get video capture to work on Mac at all, and on Windows h.264 export crashes the emulator right away. I found <a href="http://www.hoxs64.net/default.aspx">hoxs64</a> to have more stable sound but it’s otherwise not as featureful as VICE. I also tried to build my own VICE binary on Windows but that got ugly real quick when I tried to deal with the MinGW build environment.</p>
<p>Other tools used to develop BINTRIS:</p>
<ul>
<li><a href="multipaint">Multipaint</a> – for painting pixel graphics and sprites. (Although in the end, most sprites were done in Photoshop.)</li>
<li><a href="petscii">PETSCII editor</a> – for PETSCII “art” used in the readme.prg.</li>
<li><a href="https://github.com/nurpax/c64-sid-edit">SID sound editor</a> – I wrote this C64 sound editor to make it easier to tweak SID registers for my sound effects.</li>
<li><a href="https://github.com/nurpax/c64-sid-edit/blob/master/GrabSounds.hs">VICE snapshot parser</a> – a Haskell program I wrote for parsing memory snapshots. I used this to save/load the SID editor sounds. Rather than implementing save/load into my C64 app, I grabbed the sound data directly from RAM.</li>
<li><a href="https://sourceforge.net/projects/goattracker2/">GoatTracker</a> - for SID music.</li>
<li>Python - a bunch of LUT generators using numpy and PIL.</li>
</ul>
<h2 id="c64-learning-resources">C64 learning resources</h2>
<p>Here are some of my favorite C64 resources:</p>
<ul>
<li><a href="http://www.zimmers.net/cbmpics/cbm/c64/vic-ii.txt">The MOS 6567/6569 video controller (VIC-II) and its application in the Commodore 64</a> – a pretty exchaustive document on the VIC-II graphics chip.</li>
<li><a href="https://www.c64-wiki.com/wiki/Main_Page">c64-wiki</a> – I often use this for looking up assembly instructions (see e.g. <a href="https://www.c64-wiki.com/wiki/BPL">BPL</a>. I’m not a huge fan of some of the pages though. For example, the instruction reference pages would be better if they specified how an instruction works with pseudo code.</li>
<li><a href="http://sta.c64.org/cbm64mem.html">C64 memory map</a> – this is a super helpful reference for C64 registers.</li>
<li><a href="http://codebase64.org/doku.php">codebase64</a> – found a bunch of good examples here (but also many bugs!)</li>
</ul>
<p>The list is missing a good starter guide for 6510 assembly.</p>
<h2 id="next-in-series">Next in series</h2>
<p>The next blog in the series will showcase the game itself, hopefully with final version captured on real hardware.</p>
<!--$snippet("includes/bintris-c64-series.html")$-->
<!--
Bug:

<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">You can tell the release day is near when your game goes all wonky like this. <a href="https://twitter.com/hashtag/bintris?src=hash&amp;ref_src=twsrc%5Etfw">#bintris</a> <a href="https://twitter.com/hashtag/c64?src=hash&amp;ref_src=twsrc%5Etfw">#c64</a> <a href="https://t.co/Dr7orgnkSF">pic.twitter.com/Dr7orgnkSF</a></p>&mdash; Janne Hellsten (@nurpax) <a href="https://twitter.com/nurpax/status/993934121935228929?ref_src=twsrc%5Etfw">May 8, 2018</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
-->
<!--
<div class="youtube">
<iframe class="video" src="https://www.youtube.com/embed/8UjTcipfRJc?rel=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
</div>
-->
<p>Thoughts? Questions? Let’s discuss on <a href="https://www.reddit.com/r/c64coding">/r/c64coding</a>.</p>]]></summary>
</entry>
<entry>
    <title>3D Starfield in React Native</title>
    <link href="http://nurpax.github.com/posts/2018-03-02-react-native-60fps-starfield.html" />
    <id>http://nurpax.github.com/posts/2018-03-02-react-native-60fps-starfield.html</id>
    <published>2018-03-12T00:00:00Z</published>
    <updated>2018-03-12T00:00:00Z</updated>
    <summary type="html"><![CDATA[<p>I’ve been working on an iOS port of my web game <a href="http://nurpax.com/bintris">Bintris</a>. I ported the HTML/Javascript version to React Native (RN) to make it run on iOS.</p>
<p>One of the game’s main visual ingredients is the real-time 3D starfield background. I originally put it in as a kind of placeholder but came to like it over time. So I had to figure out a performant way to implement it on RN.</p>
<p>The web Bintris uses a pure-CSS starfield effect that I borrowed from <a href="https://codepen.io/keithclark/pen/ibEnk">here</a>. Here’s how my RN re-implementation looks like:</p>
<div class="youtube">
<iframe class="video" src="https://www.youtube.com/embed/thBijc6x7e0?rel=0&amp;showinfo=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen>
</iframe>
</div>
<p>Both the CSS and RN versions use a trick to project the starfield random 3d-points onto a fixed number of xy-planes. This makes it quite a bit faster to animate and render than animating each 3D point separately. In the above video, the starfield consists of ten Animated.Views each containing 150 random stars. Each star is an absolutely positioned view with a white background color.</p>
<p>React renders the starfield only once upon mounting. All further frame updates are done purely using RN animation with the native animation driver enabled using <code>useNativeDriver:true</code>. This moves starfield rendering completely off the main JavaScript UI thread. This results in buttery smooth animation and frees up the UI thread from processing all the 1500 views that make up the individual stars.</p>
<p>If you want to see it running on your phone, install the Expo app on your phone and use it to scan the QR code from <a href="https://snack.expo.io/@nurpax/starfield">this Expo Snack</a>. The full source code to the starfield is contained within the Snack project.</p>
<h2 id="improvements-ideas">Improvements ideas</h2>
<p>Here are some thoughts on what could still be improved:</p>
<ul>
<li><p><code>shouldRasterizerIOS</code> should probably be used for any views rendered on top of the starfield. Should you have any views that are rendered on top of the starfield, RN will render them at 60 FPS. If the views are complex, you may run into performance or battery consumption problems. The <code>shouldRasterizeIOS</code> should help by first rendering the static views into an image and then compositing the images on top using alpha blending. Unfortunately, I didn’t find enough information on how exactly the RN and/or iOS view renderer works, so I didn’t enable this for my menus.</p></li>
<li><p>The starfield would look smoother and less aliased if, instead of a white rectangle, a circle shaped image was used to render each individual star.</p></li>
<li><p>RN stylesheet documentation recommends using <code>StyleSheet.create()</code> instead of inline styles. I’m now using inline styles everywhere. There may be a performance benefit to using <code>StyleSheet.create()</code>. In my case though, each individual star needs its own stylesheet as a star’s absolute position must be set using a stylesheet.</p></li>
</ul>
<p>Thoughts? Questions? Let’s discuss on <a href="https://www.reddit.com/r/reactjs/comments/83yrad/60_fps_3d_starfield_in_react_native/">Reddit</a>.</p>]]></summary>
</entry>
<entry>
    <title>CMake builds from within Sublime Text 3</title>
    <link href="http://nurpax.github.com/posts/2017-01-06-cmake-sublime-text-3.html" />
    <id>http://nurpax.github.com/posts/2017-01-06-cmake-sublime-text-3.html</id>
    <published>2017-01-06T00:00:00Z</published>
    <updated>2017-01-06T00:00:00Z</updated>
    <summary type="html"><![CDATA[<p>How to setup a C++11 project with CMake and make it buildable from within a Sublime Text 3 project.</p>
<p>Example project can be found <a href="https://gist.github.com/nurpax/1927b189bccdac1fbf6389a47c8a7fab">here</a>.</p>
<h2 id="step-1-create-c-and-cmake-files">Step 1: Create C++ and CMake files</h2>
<p>Create a C++ source file:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="dt">int</span> main()</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">{</a>
<a class="sourceLine" id="cb1-5" data-line-number="5">    printf(<span class="st">&quot;Hello, world!</span><span class="sc">\n</span><span class="st">&quot;</span>);</a>
<a class="sourceLine" id="cb1-6" data-line-number="6">    <span class="cf">return</span> <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb1-7" data-line-number="7">}</a></code></pre></div>
<p>Create a CMakeLists.txt to build your C++ file:</p>
<pre><code>cmake_minimum_required (VERSION 2.6)
project (example)
set (CMAKE_CXX_FLAGS &quot;${CMAKE_CXX_FLAGS} -std=c++11&quot;)
add_executable(example main.cpp)</code></pre>
<h2 id="step-2">Step 2:</h2>
<p>Use CMake to generate your makefiles. We put these temporaries under a <code>./build</code> directory.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="fu">mkdir</span> build</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="bu">cd</span> build</a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="fu">cmake</span> ..</a></code></pre></div>
<p>If you now run <code>make</code> in the <code>./build</code> directory, your project should build.</p>
<h2 id="step-3-create-your-st3-project">Step 3: Create your ST3 project</h2>
<p>Create a <code>example.sublime-project</code> file for your project.</p>
<p>Edit the project file and add a build system (see “build_systems”):</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="fu">{</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2">    <span class="dt">&quot;folders&quot;</span><span class="fu">:</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3">    <span class="ot">[</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4">        <span class="fu">{</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5">            <span class="dt">&quot;path&quot;</span><span class="fu">:</span> <span class="st">&quot;.&quot;</span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6">        <span class="fu">}</span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7">    <span class="ot">]</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8">    <span class="dt">&quot;build_systems&quot;</span><span class="fu">:</span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9">    <span class="ot">[</span></a>
<a class="sourceLine" id="cb4-10" data-line-number="10">        <span class="fu">{</span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11">            <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;cmake&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb4-12" data-line-number="12">            <span class="dt">&quot;shell_cmd&quot;</span><span class="fu">:</span> <span class="st">&quot;make -C build&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb4-13" data-line-number="13">            <span class="dt">&quot;file_regex&quot;</span><span class="fu">:</span> <span class="st">&quot;/([^/:]+):(</span><span class="ch">\\</span><span class="st">d+):(</span><span class="ch">\\</span><span class="st">d+): &quot;</span></a>
<a class="sourceLine" id="cb4-14" data-line-number="14">        <span class="fu">}</span></a>
<a class="sourceLine" id="cb4-15" data-line-number="15">    <span class="ot">]</span></a>
<a class="sourceLine" id="cb4-16" data-line-number="16"><span class="fu">}</span></a></code></pre></div>
<p>This will add a “cmake” build system into ST3 when you open this project file. The convention used is to put the CMake generated makefiles under ./build, and thus the build command uses <code>make -C build</code> instead of just <code>make</code>.</p>
<h2 id="step-4-build-from-within-st3">Step 4: Build from within ST3</h2>
<p>Load the example project into ST3.</p>
<p>You should be able to choose <code>cmake</code> as your current build system from ST3 Tools/Build System menu.</p>
<p>If you now hit Ctrl-Shift-B (or ⌘ + ⇧ + V), your project should build and you should see the build output in bottom console window.</p>
<p>If you encountered build errors, you can go to next/prev error with F4 and Shift-F4.</p>
<h2 id="full-source-code">Full source code</h2>
<p><a href="https://gist.github.com/nurpax/1927b189bccdac1fbf6389a47c8a7fab">Project gist</a>, embedded below.</p>
<script src="https://gist.github.com/nurpax/1927b189bccdac1fbf6389a47c8a7fab.js"></script>]]></summary>
</entry>
<entry>
    <title>React Redux Todo app running on a Haskell server</title>
    <link href="http://nurpax.github.com/posts/2016-11-01-react-redux-haskell-snap.html" />
    <id>http://nurpax.github.com/posts/2016-11-01-react-redux-haskell-snap.html</id>
    <published>2016-11-01T00:00:00Z</published>
    <updated>2016-11-01T00:00:00Z</updated>
    <summary type="html"><![CDATA[<p>I put together a single-page web app (SPA) todo example for use in my personal projects. Its most noteworthy feature is end-to-end authentication implemented using <a href="https://github.com/mjrussell/redux-auth-wrapper">redux-auth-wrapper</a> and <a href="https://jwt.io/">JWT</a>. The project implements a simple todo application with user account support. Data is persisted on a server implemented in Haskell. It’s not super complex but it took quite a bit of reading to put all the pieces together, so I figured I might as well publish it for others to learn from.</p>
<p>You can find the application source code <a href="https://github.com/nurpax/snap-reactjs-todo/tree/blog-0.1">on github</a>.</p>
<p>The project uses the following tools, libraries and techniques:</p>
<ul>
<li><a href="https://facebook.github.io/react/">React</a>, <a href="https://github.com/reactjs/redux">Redux</a> and <a href="https://github.com/reactjs/react-redux">React-redux</a></li>
<li><a href="https://webpack.github.io/">Webpack</a> and <a href="https://babeljs.io/">Babel</a> (for JSX, ES6+ and CSS modules)</li>
<li><a href="https://github.com/gaearon/redux-thunk">Redux-thunk</a> for async fetching in Redux actions</li>
<li><a href="https://github.com/ReactTraining/react-router">React-router</a> and <a href="https://github.com/reactjs/react-router-redux">React-router-redux</a> for routing</li>
<li><a href="https://github.com/mjrussell/redux-auth-wrapper">Redux-auth-wrapper</a> for implementing robust authenticated routing and login screens</li>
<li><a href="https://jwt.io/">JWT</a>-based authentication that works well with Redux and routing</li>
<li>Haskell for the backend using the <a href="http://snapframework.com/">Snap web framework</a> to serve the REST API</li>
<li>Roll-my-own JWT authentication code for the Haskell backend</li>
</ul>
<p>The development setup does not implement hot module reloading (HMR) or server-side rendering (SSR). I imagine it’s possible to extend this setup for HMR. I don’t know if SSR is feasible without a Node.js based server.</p>
<p>I won’t explain each and every one of the above libraries in details. They all have fairly good documentation and a whole bunch of tutorials on the net. Instead, I will just highlight some of the most relevant parts.</p>
<h1 id="client-side">Client-side</h1>
<p>Client routes are setup in <a href="https://github.com/nurpax/snap-reactjs-todo/blob/blog-0.1/client/containers/Root.js">client/containers/Root.js</a>:</p>
<pre><code>const Root = () =&gt; (
  &lt;Provider store={store}&gt;
    &lt;Router history={history}&gt;
      &lt;Route path=&#39;/&#39; component={Main} /&gt;
      &lt;Route path=&#39;/todos&#39; component={UserIsAuthenticated(TodoList)} /&gt;
      &lt;Route path=&#39;/login&#39; component={Login} /&gt;
      &lt;Route path=&#39;/profile&#39; component={UserIsAuthenticated(Profile)} /&gt;
      &lt;Route path=&#39;/signup&#39; component={SignUp} /&gt;
    &lt;/Router&gt;
  &lt;/Provider&gt;)</code></pre>
<p>This sets up various routes like the home screen, todo list and login and logout routes. Notice the <code>UserIsAuthenticated</code> higher-order component that applies authentication constraints on the <code>TodoList</code> and <code>Profile</code> components. Those routes won’t be accessible unless the user is logged in.</p>
<p>See <a href="https://github.com/mjrussell/redux-auth-wrapper">redux-auth-wrapper</a> for more information on setting up authentication and redux.</p>
<h2 id="authenticated-fetch">Authenticated fetch</h2>
<p>Client-side JWT handling is implemented in <a href="https://github.com/nurpax/snap-reactjs-todo/blob/blog-0.1/client/auth.js">client/auth.js</a>. It implements Redux actions and reducers related to user authentication. It exports a function called <code>fetchWithAuth</code> which is used instead of <code>fetch</code> whenever accessing API endpoints that require authentication.</p>
<p>Here’s an example of how <code>fetchWithAuth</code> is used in <a href="https://github.com/nurpax/snap-reactjs-todo/blob/blog-0.1/client/actions.js">client/actions.js</a> to save a todo item:</p>
<pre><code>export function saveTodo (todo) {
  return function (dispatch, getState) {
    return fetchWithAuth(getState, &#39;/api/todo&#39;, { method: &#39;POST&#39;, body: todo })
      .then(json =&gt; dispatch(receiveTodo(json)))
  }
}</code></pre>
<p>The <code>fetchWithAuth</code> function is basically just a wrapper around <code>fetch</code> that inserts the JWT user token into the Authorization header when issuing a fetch call.</p>
<p>It currently does not handle expired tokens, though. It should be easy to extend it such that it will detect an expired token error, and issue an action that triggers a client-side redirect to the login screen.</p>
<h1 id="api-server">API server</h1>
<p>The backend is written in Haskell. It uses the Snap framework to get a basic web server running. It’s main functionality is to persist users and todo items and serve them via a JSON API. Apart from the one static <a href="https://github.com/nurpax/snap-reactjs-todo/blob/blog-0.1/static/index.html">index.html</a> used to bootstrap React, the server does not render any HTML.</p>
<p>The relevant source files are:</p>
<ul>
<li><a href="https://github.com/nurpax/snap-reactjs-todo/blob/blog-0.1/src/Site.hs">src/Site.hs</a> – Routes and API implementation</li>
<li><a href="https://github.com/nurpax/snap-reactjs-todo/blob/blog-0.1/src/Db.hs">src/Db.hs</a> – <a href="https://hackage.haskell.org/package/aeson">sqlite-simple</a> code for persisting todo items into a SQLite3 database</li>
<li><a href="https://github.com/nurpax/snap-reactjs-todo/blob/blog-0.1/src/Snap/Snaplet/SqliteJwt.hs">src/Snaplet/SqliteJwt.hs</a> – A Snap middleware that implements user accounts, password hashing and salting using BCrypt, and JWT for sessionless authentication.</li>
</ul>
<p>The request handler for todo items looks like so:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="ot">handleRestTodos ::</span> <span class="dt">H</span> ()</a>
<a class="sourceLine" id="cb3-2" data-line-number="2">handleRestTodos <span class="fu">=</span> (method <span class="dt">GET</span> listTodos) <span class="fu">&lt;|&gt;</span> (method <span class="dt">POST</span> saveTodo)</a>
<a class="sourceLine" id="cb3-3" data-line-number="3">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="ot">    listTodos ::</span> <span class="dt">H</span> ()</a>
<a class="sourceLine" id="cb3-5" data-line-number="5">    listTodos <span class="fu">=</span> replyJson query</a>
<a class="sourceLine" id="cb3-6" data-line-number="6">      <span class="kw">where</span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7">        query (<span class="dt">J.User</span> uid _) <span class="fu">=</span> withTop db <span class="fu">$</span> Db.listTodos (<span class="dt">Db.UserId</span> uid)</a>
<a class="sourceLine" id="cb3-8" data-line-number="8"></a>
<a class="sourceLine" id="cb3-9" data-line-number="9">    saveTodo <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb3-10" data-line-number="10">      ps <span class="ot">&lt;-</span> reqJSON</a>
<a class="sourceLine" id="cb3-11" data-line-number="11">      replyJson (query ps)</a>
<a class="sourceLine" id="cb3-12" data-line-number="12">      <span class="kw">where</span></a>
<a class="sourceLine" id="cb3-13" data-line-number="13">        query ps (<span class="dt">J.User</span> uid _) <span class="fu">=</span></a>
<a class="sourceLine" id="cb3-14" data-line-number="14">          <span class="co">-- If the input todo id is Nothing, create a new todo.  Otherwise update</span></a>
<a class="sourceLine" id="cb3-15" data-line-number="15">          <span class="co">-- an existing one.</span></a>
<a class="sourceLine" id="cb3-16" data-line-number="16">          <span class="kw">case</span> ptId ps <span class="kw">of</span></a>
<a class="sourceLine" id="cb3-17" data-line-number="17">            <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb3-18" data-line-number="18">              withTop db <span class="fu">$</span> Db.newTodo (<span class="dt">Db.UserId</span> uid) (ptText ps)</a>
<a class="sourceLine" id="cb3-19" data-line-number="19">            <span class="dt">Just</span> tid <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb3-20" data-line-number="20">              <span class="kw">let</span> newTodo <span class="fu">=</span> <span class="dt">Db.Todo</span> tid (ptSavedOn ps) (ptCompleted ps) (ptText ps)</a>
<a class="sourceLine" id="cb3-21" data-line-number="21">              withTop db <span class="fu">$</span> Db.saveTodo (<span class="dt">Db.UserId</span> uid) newTodo</a>
<a class="sourceLine" id="cb3-22" data-line-number="22"></a>
<a class="sourceLine" id="cb3-23" data-line-number="23"><span class="ot">    replyJson ::</span> <span class="dt">ToJSON</span> a <span class="ot">=&gt;</span> (<span class="dt">J.User</span> <span class="ot">-&gt;</span> <span class="dt">Handler</span> <span class="dt">App</span> <span class="dt">J.SqliteJwt</span> a) <span class="ot">-&gt;</span> <span class="dt">H</span> ()</a>
<a class="sourceLine" id="cb3-24" data-line-number="24">    replyJson action <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb3-25" data-line-number="25">      res <span class="ot">&lt;-</span> with jwt <span class="fu">$</span> J.requireAuth action</a>
<a class="sourceLine" id="cb3-26" data-line-number="26">      writeJSON res</a></code></pre></div>
<p>Query parameters for the <code>saveTodo</code> POST requests are passed in as JSON and parsed with the <a href="https://hackage.haskell.org/package/aeson">aeson</a> JSON parser. Static type checking enforces that invalid request parameters don’t get past the JSON parser.</p>
<p>Server-side authentication is implemented in the <a href="https://github.com/nurpax/snap-reactjs-todo/blob/blog-0.1/src/Snap/Snaplet/SqliteJwt.hs">SqliteJwt</a> module. It exports the <code>requireAuth</code> function which is used above to wrap request handlers. A wrapped handler will either be passed down the currently authenticated user or the request is terminated if JWT authentication failed.</p>
<h1 id="future-work">Future work</h1>
<p>The Haskell SqliteJwt module is work-in-progress and certainly not ready for production. For example, it doesn’t currently support token expiration or revoking existing tokens. It also hardcodes the site secret used to sign JWTs. I am planning to develop this module further to support these features and maybe publish it on Hackage.</p>
<p>It’d also be interesting to plug in an external authentication mechanism like Google OAuth 2.0. I haven’t found good examples on how to do this robustly. There is discussion about this in redux-auth-wrapper <a href="https://github.com/mjrussell/redux-auth-wrapper/issues/46">github issue #46</a> but I haven’t tried toying around with those ideas yet. It will probably be quite a bit trickier than local authentication.</p>
<p>Thanks for reading!</p>]]></summary>
</entry>
<entry>
    <title>Fixing Emacs GDB mode, part 1</title>
    <link href="http://nurpax.github.com/posts/2014-10-12-fixing-gdb-many-windows-source-buffer.html" />
    <id>http://nurpax.github.com/posts/2014-10-12-fixing-gdb-many-windows-source-buffer.html</id>
    <published>2014-10-12T00:00:00Z</published>
    <updated>2014-10-12T00:00:00Z</updated>
    <summary type="html"><![CDATA[<p>I like using use the Emacs <code>gud-mode</code> for my debugging sessions. Unfortunately, it’s pretty quirky in how it assigns source files to Emacs windows. This totally breaks my debugging flow. Today I decided to document this misbehavior and in a later post, explain how to fix it.</p>
<p>The problem occurs when stepping through a program in <code>gud-mode</code> with <code>gdb-many-windows</code> enabled. I’d expect Emacs to assign new source buffers into the dedicated middle-left source window. Instead, source buffers are (randomly?) assigned on top of other GDB buffers like the GDB comint window. The layout problem gets even worse with multiple Emacs frames. Here are my repro steps with a diagram of what happens and how I’d like Emacs to behave instead.</p>
<p>Here are the steps to reproduce the problem on Emacs 24.3.1.</p>
<p>Bind <code>gud-next</code> and <code>gud-step</code> to <code>[f7]</code> and <code>[f8]</code>:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode lisp"><code class="sourceCode commonlisp"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="co">;; This goes into your .emacs</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2">(add-hook &#39;gud-mode-hook</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">          &#39;(<span class="kw">lambda</span> ()</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">             (global-set-key (kbd <span class="st">&quot;&lt;f7&gt;&quot;</span>) &#39;gud-next)</a>
<a class="sourceLine" id="cb1-5" data-line-number="5">             (global-set-key (kbd <span class="st">&quot;&lt;f8&gt;&quot;</span>) &#39;gud-step)))</a></code></pre></div>
<p>Build my example program:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="fu">git</span> clone https://gist.github.com/d94e2666ae05b58906c6.git emacs-gdb-proj</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="bu">cd</span> emacs-gdb-proj</a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="fu">make</span></a></code></pre></div>
<p>Start Emacs and enter GDB:</p>
<pre><code>emacs &amp;
M-x gdb
M-x gdb-many-windows</code></pre>
<p>Use <code>*gud-test*</code> comint buffer to set a break point in <code>main()</code> and run the program:</p>
<pre><code>(gdb) b main
Breakpoint 1 at 0x4004b1: file main.c, line 6.
(gdb) r</code></pre>
<p>The window layout should now look something like this (the source window with <code>main.c</code> highlighted):</p>
<svg width="600" height="400">
<!-- gud-test, locals of test -->
<g transform="translate(0 0)"> <rect width="50%" height="33%" style="fill:rgb(0,43,53); stroke-width:2; stroke:rgb(0,0,0)" /> <text x="5%" y="18%" font-size="20" font-family="Helvetica" fill="rgb(131,148,150)">*gud-test*</text> </g> <g transform="translate(300 0)"> <rect width="50%" height="33%" style="fill:rgb(0,43,53); stroke-width:2; stroke:rgb(0,0,0)" /> <text x="5%" y="18%" font-family="Helvetica" font-size="20" fill="rgb(131,148,150)">*locals of test*</text> </g> <!-- source window, output window --> <g transform="translate(0 133)"> <rect width="50%" height="33%" style="fill:rgb(101,123,131); stroke-width:2; stroke:rgb(0,0,0)" /> <text x="5%" y="18%" font-family="Helvetica" font-size="20" fill="rgb(0,43,53)">./main.c</text> </g> <g transform="translate(300 133)"> <rect width="50%" height="33%" style="fill:rgb(0,43,53); stroke-width:2; stroke:rgb(0,0,0)" /> <text x="5%" y="18%" font-family="Helvetica" font-size="20" fill="rgb(131,148,150)">*input/output of test*</text> </g> <!-- stack frame, breakpoints --> <g transform="translate(0 266)"> <rect width="50%" height="33%" style="fill:rgb(0,43,53); stroke-width:2; stroke:rgb(0,0,0)" /> <text x="5%" y="18%" font-family="Helvetica" font-size="20" fill="rgb(131,148,150)">*stack frames of test*</text> </g> <g transform="translate(300 266)"> <rect width="50%" height="33%" style="fill:rgb(0,43,53); stroke-width:2; stroke:rgb(0,0,0)" /> <text x="5%" y="18%" font-family="Helvetica" font-size="20" fill="rgb(131,148,150)">*breakpoints of test*</text> </g>
</svg>
<p>The contents of <code>main.c</code> look like this:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="dt">int</span> main() </a>
<a class="sourceLine" id="cb5-4" data-line-number="4">{</a>
<a class="sourceLine" id="cb5-5" data-line-number="5">    foo();</a>
<a class="sourceLine" id="cb5-6" data-line-number="6">    foo();</a>
<a class="sourceLine" id="cb5-7" data-line-number="7">    foo();</a>
<a class="sourceLine" id="cb5-8" data-line-number="8">}</a></code></pre></div>
<p>If you step into the <code>foo()</code> function with <code>[f8]</code>, you’re taken into the <code>b.c</code> source file, which opens as expected into left-middle source window.</p>
<p>However, if instead of directly stepping into <code>foo()</code> you open another source file in the source window, say, <code>C-x C-f</code>’ing the <code>Makefile</code> from the test project and hit <code>[f8]</code> again, BOOM, the <code>b.c</code> buffer opens in the comint <code>*gud-test*</code> window and not in the source window! The window layout now looks like this:</p>
<svg width="600" height="400">
<!-- b.c, locals of test -->
<g transform="translate(0 0)"> <rect width="50%" height="33%" style="fill:rgb(101,123,131); stroke-width:2; stroke:rgb(0,0,0)" /> <text x="5%" y="18%" font-family="Helvetica" font-size="20" fill="rgb(0,43,53)">./b.c</text> </g> <g transform="translate(300 0)"> <rect width="50%" height="33%" style="fill:rgb(0,43,53); stroke-width:2; stroke:rgb(0,0,0)" /> <text x="5%" y="18%" font-family="Helvetica" font-size="20" fill="rgb(131,148,150)">*locals of test*</text> </g> <!-- source window, output window --> <g transform="translate(0 133)"> <rect width="50%" height="33%" style="fill:rgb(101,123,131); stroke-width:2; stroke:rgb(0,0,0)" /> <text x="5%" y="18%" font-family="Helvetica" font-size="20" fill="rgb(0,43,53)">./Makefile</text> </g> <g transform="translate(300 133)"> <rect width="50%" height="33%" style="fill:rgb(0,43,53); stroke-width:2; stroke:rgb(0,0,0)" /> <text x="5%" y="18%" font-family="Helvetica" font-size="20" fill="rgb(131,148,150)">*input/output of test*</text> </g> <!-- stack frame, breakpoints --> <g transform="translate(0 266)"> <rect width="50%" height="33%" style="fill:rgb(0,43,53); stroke-width:2; stroke:rgb(0,0,0)" /> <text x="5%" y="18%" font-family="Helvetica" font-size="20" fill="rgb(131,148,150)">*stack frames of test*</text> </g> <g transform="translate(300 266)"> <rect width="50%" height="33%" style="fill:rgb(0,43,53); stroke-width:2; stroke:rgb(0,0,0)" /> <text x="5%" y="18%" font-family="Helvetica" font-size="20" fill="rgb(131,148,150)">*breakpoints of test*</text> </g>
</svg>
<p>Another way to trigger the same:</p>
<ol type="1">
<li>Start <code>gud-mode</code> + <code>gdb-many-windows</code> as above.</li>
<li>Step into <code>foo()</code>.</li>
<li>Open the <code>Makefile</code> into the source window.</li>
<li>Click on any of the functions/source files into bottom-left stack frame window.</li>
</ol>
<p>Again, the source file opens on top of the upper-left comint window.</p>
<p>I did find some related Stackoverflow posts. <a href="http://stackoverflow.com/questions/3473134/emacs-23-1-1-with-gdb-forcing-source-windows">This post</a> contains a <code>defadvice</code> trick that seems to work for the latter reproduction steps, but it didn’t make a difference in the former case. <a href="http://stackoverflow.com/questions/24386672/use-gdb-within-emacs-always-show-the-source-code.">Another post</a> discusses a related problem but concludes that there’s no problem if you just use <code>gdb-many-windows</code>.</p>
<p>I hope to resolve this soon and update this post with a solution.</p>]]></summary>
</entry>
<entry>
    <title>REST API testing in Haskell with wreq and test-framework</title>
    <link href="http://nurpax.github.com/posts/2014-05-03-rest-testing-with-wreq.html" />
    <id>http://nurpax.github.com/posts/2014-05-03-rest-testing-with-wreq.html</id>
    <published>2014-05-04T00:00:00Z</published>
    <updated>2014-05-04T00:00:00Z</updated>
    <summary type="html"><![CDATA[<h2 id="introduction">Introduction</h2>
<p>This blog post is about my experiences rewriting Node.js/JavaScript-based REST unit tests in Haskell using <a href="http://hackage.haskell.org/package/wreq">wreq</a> and <a href="https://batterseapower.github.io/test-framework/">test-framework</a>. I hope the test cases presented in this post are useful practical examples of using <code>test-framework</code> for IO-heavy testing.</p>
<p>The tests discussed in this post are for my <a href="https://github.com/nurpax/hswtrack">Hswtrack</a> project. Hswtrack is a web application for exercise tracking. The application server is built with <a href="http://snapframework.com/">Snap</a> and the UI in JavaScript with JQuery and <a href="http://handlebarsjs.com/">Handlebars.js</a>.</p>
<p>Here’s a summary of what type of REST entry points will be tested in this post:</p>
<table>
<thead>
<tr class="header">
<th>Entry point</th>
<th>Verb</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>/rest/login</code></td>
<td>POST</td>
<td>Login with <code>login</code> and <code>password</code> parameters.</td>
</tr>
<tr class="even">
<td><code>/rest/new_user</code></td>
<td>POST</td>
<td>Create a user with <code>login</code> and <code>password</code> parameters.</td>
</tr>
<tr class="odd">
<td><code>/rest/app</code></td>
<td>GET</td>
<td>Get logged in user login name and status.</td>
</tr>
<tr class="even">
<td><code>/rest/exercise</code></td>
<td>GET</td>
<td>List existing exercises.</td>
</tr>
<tr class="odd">
<td><code>/rest/exercise</code></td>
<td>POST</td>
<td>Create a new exercise with <code>name</code> and <code>type</code> parameters.</td>
</tr>
</tbody>
</table>
<p>Most entry point require a prior successful login. The response body is encoded as JSON. When called unauthenticated, the server returns an HTTP 403 error code.</p>
<p>As the server talks to the client in JSON, I initially thought JavaScript + NodeJS would be a nice combo for developing these tests. I first tried <a href="http://frisbyjs.com/">Frisby</a> which looked simple and had good looking documentation. Unfortunately it turned out to be cumbersome for the types of tests I wanted to write. I also tried writing my own test framework with Q promises but that came out like <a href="https://twitter.com/SlexAxton/status/455568049181958144">Tea party code</a> too. (You can view the source for my JavaScript tests <a href="https://github.com/nurpax/hswtrack/blob/0e820183ce28a6e62056c0dda7c99d5109ad3e68/test/rest/tests/workout.js">here</a>.)</p>
<p>Feeling dissatisfied about the state of my tests, I decided to rewrite my unit tests in Haskell.</p>
<h2 id="types-of-tests">Types of tests</h2>
<p>I wanted to develop the following types of tests:</p>
<ul>
<li>Test that user creation works</li>
<li>Test that login works</li>
<li>Test that REST entry points deny access if not logged in</li>
<li>Test object creation, update and deletion when logged in</li>
<li>Test that attempts to modify or delete other users’ data are rejected</li>
</ul>
<p>Any tests that modify or create objects need to run with an authenticated user. This means each such test would need to either log in as part of its init sequence or have its authentication cookies passed into it. I went for the latter approach as it allows logging in once and running multiple tests with the same cookies.</p>
<p>I define top-level test cases called <code>createUserTests</code> and <code>loginUserTests</code> which first perform user creation or login, followed by running a list of sub-tests with cookies acquired from the login process. The sequencing is explicitly declared by using <code>test-framework</code>’s <code>TestGroup</code>s and <code>Test</code>s.</p>
<p>Here’s the definition of <code>loginUserTests</code>:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="co">-- | Login a user and run a list of subtests with cookies acquired</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="co">-- from the login process.</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="ot">loginUserTests ::</span> [(<span class="dt">String</span>, <span class="dt">Options</span> <span class="ot">-&gt;</span> <span class="dt">Assertion</span>)] <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">Test</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4">loginUserTests tests <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5">  r <span class="ot">&lt;-</span> post (mkUrl <span class="st">&quot;/rest/login&quot;</span>) [<span class="st">&quot;login&quot;</span> <span class="fu">:=</span> login, <span class="st">&quot;password&quot;</span> <span class="fu">:=</span> passwd]</a>
<a class="sourceLine" id="cb1-6" data-line-number="6">  <span class="kw">let</span> opts <span class="fu">=</span> defaults <span class="fu">&amp;</span> cookies <span class="fu">.~</span> (r <span class="fu">^.</span> responseCookieJar)</a>
<a class="sourceLine" id="cb1-7" data-line-number="7">  return</a>
<a class="sourceLine" id="cb1-8" data-line-number="8">    <span class="fu">.</span> testGroup <span class="st">&quot;Tests with logged in user&quot;</span></a>
<a class="sourceLine" id="cb1-9" data-line-number="9">    <span class="fu">.</span> map (\(name, test) <span class="ot">-&gt;</span> testCase name (test opts)) <span class="fu">$</span> tests</a></code></pre></div>
<p>It performs a HTTP POST on <code>/rest/login</code> with the test user’s login credentials, grabs the authentication cookies with <code>defaults &amp; cookies .~ (r ^. responseCookieJar)</code> and passes them to sub-tests so that they can run authenticated.</p>
<p>Here’s how <code>loginUserTests</code> gets used:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co">-- Test case that tests that we&#39;re successfully logged in</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="co">-- Options must contain the necessary login cookies.</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="ot">testLoggedInOk ::</span> <span class="dt">Options</span> <span class="ot">-&gt;</span> <span class="dt">Assertion</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4">testLoggedInOk opts <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5">  r <span class="ot">&lt;-</span> getWith opts (mkUrl <span class="st">&quot;/rest/app&quot;</span>)</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">  <span class="dt">Just</span> <span class="dt">True</span> <span class="fu">@=?</span> (r <span class="fu">^?</span> responseBody <span class="fu">.</span> key <span class="st">&quot;loggedIn&quot;</span> <span class="fu">.</span> _Bool)</a>
<a class="sourceLine" id="cb2-7" data-line-number="7"></a>
<a class="sourceLine" id="cb2-8" data-line-number="8"><span class="ot">main ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb2-9" data-line-number="9">main <span class="fu">=</span></a>
<a class="sourceLine" id="cb2-10" data-line-number="10">  defaultMain</a>
<a class="sourceLine" id="cb2-11" data-line-number="11">  [ buildTest <span class="fu">$</span> createUserTests [(<span class="st">&quot;logged in?&quot;</span>, testLoggedInOk)]</a>
<a class="sourceLine" id="cb2-12" data-line-number="12">  , buildTest <span class="fu">$</span> loginUserTests  [(<span class="st">&quot;logged in?&quot;</span>, testLoggedInOk)]</a>
<a class="sourceLine" id="cb2-13" data-line-number="13">  ]</a></code></pre></div>
<p>Function <code>testLoggedInOk</code> tests that it can HTTP GET <code>/rest/app</code> successfully. It also tests that the returned JSON object contains a field <code>loggedIn</code> with value <code>true</code>.</p>
<h2 id="negative-testing">Negative testing</h2>
<p>One shouldn’t forget about negative testing, so let’s develop a test for checking that entry points correctly respond with an error 403 on unauthenticated access:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="co">-- GET requests against &#39;url&#39; and expect to get error 403 back</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="ot">testLoggedInFail ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Options</span> <span class="ot">-&gt;</span> <span class="dt">Assertion</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3">testLoggedInFail url opts <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4">  E.try (getWith opts url) <span class="fu">&gt;&gt;=</span> check</a>
<a class="sourceLine" id="cb3-5" data-line-number="5">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6">    check (<span class="dt">Left</span> (<span class="dt">HT.StatusCodeException</span> s _ _))</a>
<a class="sourceLine" id="cb3-7" data-line-number="7">      <span class="fu">|</span> s <span class="fu">^.</span> statusCode <span class="fu">==</span> <span class="dv">403</span> <span class="fu">=</span> assertBool <span class="st">&quot;error ok&quot;</span> <span class="dt">True</span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8">      <span class="fu">|</span> otherwise              <span class="fu">=</span> assertBool <span class="st">&quot;unexpected status code&quot;</span> <span class="dt">False</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9">    check (<span class="dt">Left</span> _)  <span class="fu">=</span> assertBool <span class="st">&quot;unexpected exception caught&quot;</span> <span class="dt">False</span></a>
<a class="sourceLine" id="cb3-10" data-line-number="10">    check (<span class="dt">Right</span> r) <span class="fu">=</span> assertBool <span class="st">&quot;req should&#39;ve failed&quot;</span> <span class="dt">False</span></a>
<a class="sourceLine" id="cb3-11" data-line-number="11"></a>
<a class="sourceLine" id="cb3-12" data-line-number="12"><span class="ot">main ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb3-13" data-line-number="13">main <span class="fu">=</span></a>
<a class="sourceLine" id="cb3-14" data-line-number="14">  defaultMain [testGroup <span class="st">&quot;Require auth fail&quot;</span> requireAuthFail]</a>
<a class="sourceLine" id="cb3-15" data-line-number="15">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb3-16" data-line-number="16">    requireAuthFail <span class="fu">=</span></a>
<a class="sourceLine" id="cb3-17" data-line-number="17">      map (\u <span class="ot">-&gt;</span> testCase u (testLoggedInFail (mkUrl u) defaults)) authReqd</a>
<a class="sourceLine" id="cb3-18" data-line-number="18">    <span class="co">-- REST entry points which require user to be logged in</span></a>
<a class="sourceLine" id="cb3-19" data-line-number="19">    authReqd <span class="fu">=</span> [ <span class="st">&quot;/rest/app&quot;</span></a>
<a class="sourceLine" id="cb3-20" data-line-number="20">               , <span class="st">&quot;/rest/weights&quot;</span></a>
<a class="sourceLine" id="cb3-21" data-line-number="21">               , <span class="st">&quot;/rest/notes&quot;</span></a>
<a class="sourceLine" id="cb3-22" data-line-number="22">               , <span class="st">&quot;/rest/exercise&quot;</span></a>
<a class="sourceLine" id="cb3-23" data-line-number="23">               , <span class="st">&quot;/rest/workout/exercise&quot;</span></a>
<a class="sourceLine" id="cb3-24" data-line-number="24">               , <span class="st">&quot;/rest/workout&quot;</span></a>
<a class="sourceLine" id="cb3-25" data-line-number="25">               , <span class="st">&quot;/rest/workout&quot;</span></a>
<a class="sourceLine" id="cb3-26" data-line-number="26">               , <span class="st">&quot;/rest/stats/workout&quot;</span></a>
<a class="sourceLine" id="cb3-27" data-line-number="27">               ]</a></code></pre></div>
<h2 id="creating-objects">Creating objects</h2>
<p>Here we will test two entry points: one for creating a new exercise like “Chin-ups” and one for listing existing exercises. Creation is a HTTP POST to <code>/rest/exercise</code> and listing exercises is HTTP GET <code>/rest/exercise</code>.</p>
<p>A successful POST to <code>/rest/exercise</code> will create a new object on the server and return the object to the client as JSON. Here’s what that repsonse might look like:</p>
<pre><code>{ &quot;id&quot;:2, &quot;name&quot;: &quot;Chin-ups&quot;, &quot;type&quot;:&quot;BW&quot; }</code></pre>
<p>A successful GET of <code>/rest/exercise</code> will retrieve the full list of available exercises. It looks something like this:</p>
<pre><code>[
  { &quot;id&quot;:1, &quot;name&quot;: &quot;Push-ups&quot;, &quot;type&quot;:&quot;BW&quot; },
  { &quot;id&quot;:2, &quot;name&quot;: &quot;Chin-ups&quot;, &quot;type&quot;:&quot;BW&quot; }
]</code></pre>
<p>To test creating exercise objects, we’ll create an exercise, verify that its returned properties match what we gave on creation, and finally retrieve the complete exercise list and check that the object is listed.</p>
<p>Here’s the code for the above test strategy. The <a href="http://hackage.haskell.org/package/lens/docs/Data-Aeson-Lens.html">Aeson Lens API</a> is particularly handy for this type of ad hoc JSON value inspection!</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="ot">testAddExercise ::</span> <span class="dt">Options</span> <span class="ot">-&gt;</span> <span class="dt">Assertion</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2">testAddExercise opts <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3">  <span class="kw">let</span> name <span class="fu">=</span> <span class="st">&quot;Chin-ups&quot;</span><span class="ot"> ::</span> <span class="dt">T.Text</span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4">      ty   <span class="fu">=</span> <span class="st">&quot;BW&quot;</span><span class="ot">       ::</span> <span class="dt">T.Text</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5">  r <span class="ot">&lt;-</span> postWith opts (mkUrl <span class="st">&quot;/rest/exercise&quot;</span>) [<span class="st">&quot;name&quot;</span> <span class="fu">:=</span> name, <span class="st">&quot;type&quot;</span> <span class="fu">:=</span> ty]</a>
<a class="sourceLine" id="cb6-6" data-line-number="6">  <span class="co">-- Verify that the newly created object matches creation params</span></a>
<a class="sourceLine" id="cb6-7" data-line-number="7">  name <span class="fu">@=?</span> r <span class="fu">^.</span> responseBody <span class="fu">.</span> key <span class="st">&quot;name&quot;</span> <span class="fu">.</span> _String</a>
<a class="sourceLine" id="cb6-8" data-line-number="8">  ty   <span class="fu">@=?</span> r <span class="fu">^.</span> responseBody <span class="fu">.</span> key <span class="st">&quot;type&quot;</span> <span class="fu">.</span> _String</a>
<a class="sourceLine" id="cb6-9" data-line-number="9">  <span class="co">-- Verify that the object ended up in the global list of exercises</span></a>
<a class="sourceLine" id="cb6-10" data-line-number="10">  <span class="kw">let</span> (<span class="dt">Just</span> oid) <span class="fu">=</span> r <span class="fu">^?</span> responseBody <span class="fu">.</span> key <span class="st">&quot;id&quot;</span> <span class="fu">.</span> _Integer</a>
<a class="sourceLine" id="cb6-11" data-line-number="11">  r <span class="ot">&lt;-</span> getWith opts (mkUrl <span class="st">&quot;/rest/exercise&quot;</span>)</a>
<a class="sourceLine" id="cb6-12" data-line-number="12">  assertBool <span class="st">&quot;oid should be in list&quot;</span> (oid <span class="ot">`elem`</span> exercises r)</a>
<a class="sourceLine" id="cb6-13" data-line-number="13">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb6-14" data-line-number="14">    exercises r <span class="fu">=</span> r <span class="fu">^..</span> responseBody <span class="fu">.</span> values <span class="fu">.</span> key <span class="st">&quot;id&quot;</span> <span class="fu">.</span> _Integer</a></code></pre></div>
<h2 id="conclusion">Conclusion</h2>
<p>I only just got started developing these tests and so coverage is still poor. I’m pretty sure that as I develop new tests, interesting ways to restructure and generalize these tests will emerge.</p>
<p>You can find the full source code to these tests <a href="https://github.com/nurpax/hswtrack/blob/blog-may-version/test/Test.hs">here</a>.</p>
<p>Thanks for reading!</p>]]></summary>
</entry>
<entry>
    <title>Installing Haskell Platform on Debian testing</title>
    <link href="http://nurpax.github.com/posts/2014-02-20-haskell-platform-installation.html" />
    <id>http://nurpax.github.com/posts/2014-02-20-haskell-platform-installation.html</id>
    <published>2014-02-20T00:00:00Z</published>
    <updated>2014-02-20T00:00:00Z</updated>
    <summary type="html"><![CDATA[<p>I usually hit some snags when installing Haskell Platform (HP) on either Ubuntu or Debian. I thought this time I would get lucky, and get it installed without trouble.</p>
<h2 id="first-attempt">First Attempt</h2>
<p>In anticipation of a great success, I first blew away all my local installs of HP and GHC, followed by direct <code>haskell-platform</code> package installation:</p>
<pre><code>apt-get install haskell-platform</code></pre>
<p>D’oh, Debian testing’s HP is at 2012.2.0.0. Too old, I want a later version.</p>
<p>HP 2013.2.0.0 requires GHC 7.6.3, so let’s install that. I follow the links on <a href="http://www.haskell.org/platform/linux.html">Haskell Platform for Linux</a> and find the GHC 7.6.3 binary release. Trying to install it according to its installation steps..</p>
<p>Hmm, a problem with <code>libgmp.so.3</code>:</p>
<pre><code>~/t/ghc-7.6.3$ ./configure 
checking for path to top of build tree... utils/ghc-pwd/dist-install/build/tmp/ghc-pwd: 
error while loading shared libraries: libgmp.so.3: cannot open shared object file: 
No such file or directory</code></pre>
<p>I try installing <code>libgmp.so.3</code>:</p>
<pre><code>apt-get install libgmp-dev</code></pre>
<p>Oh, it’s already at a newer version, i.e., at <code>libgmp.so.10</code>.</p>
<p>Googling.. Oh, symlink to fake that I have libgmp.so.3. Sounds dodgy. Well, I’ll install GHC from source instead.</p>
<p>So I download the GHC 7.6.3 source package, build it and install it. At this point you need to have <em>some</em> older version of GHC still installed. So I use GHC 7.4.1 from the Debian testing package.</p>
<p>With all this done, installing Haskell Platform from source is easy if you managed to correctly install all the prerequisites.</p>
<p>Then I try to update my <code>cabal-install</code>, so I do:</p>
<pre><code>cabal update
cabal install cabal-install</code></pre>
<p>Whoops:</p>
<pre><code>Building cabal-install-1.18.0.2...
Preprocessing executable &#39;cabal&#39; for cabal-install-1.18.0.2...

Main.hs:118:8:
    Could not find module `Distribution.Version&#39;
    There are files missing in the `Cabal-1.18.1.1&#39; package,
    try running &#39;ghc-pkg check&#39;.
    Use -v to see a list of the files searched for.</code></pre>
<p>Even though I had blown away my <code>.cabal</code> and previous HP installation directories from under my <code>$HOME</code>, I still had managed to leave in a <code>.ghc</code> directory. Nuking that fixed the last problem.</p>
<h2 id="final-installation-steps">Final Installation Steps</h2>
<p>For my future reference, here are the high-level steps I took to install the latest released Haskell Platform:</p>
<ol type="1">
<li>Prerequisites: some version of GHC installed. In my case GHC 7.4.1 from Debian. Various other packages are needed for HP, these are easy to google so not listing them here.</li>
<li>Download GHC 7.6.3 source release, standard <code>./configure &amp;&amp; make &amp;&amp; make install</code> installation</li>
<li>Check that <code>ghc --version</code> is 7.6.3. If it’s not, your PATH points to the previous GHC version.
<ul>
<li>Not sure if it’s recommended to remove the previous GHC installation at this point. Will I get into trouble with conflicting GHC versions if I don’t remove it here?</li>
<li>Removed GHC 7.4.1 with <code>apt-get remove ghc</code> and <code>hash -r</code> to let bash know <code>ghc</code> is at a new location now.</li>
</ul></li>
<li>Download the Haskell Platform 2013.2.0.0 source tarball from <a href="http://www.haskell.org/platform/linux.html">haskell.org/platform/linux.html</a>
<ul>
<li>Install as per instructions while being careful to choose a global package database installation as opposed to a user local package db. Otherwise you may face issues like <a href="https://github.com/haskell/cabal/issues/1695">cabal-install #1695</a>.</li>
</ul></li>
</ol>
<p>Phew, now it’s all done.</p>]]></summary>
</entry>

</feed>
