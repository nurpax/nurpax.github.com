<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta name="viewport" content="width=device-width">
        <link href="https://fonts.googleapis.com/css?family=Montserrat|Source+Sans+Pro" rel="stylesheet">
        <title>nurpax - C64jasm - a new take on C64 macro assembling</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />

        <link rel="stylesheet" type="text/css" href="../css/syntax.css" />

        <link rel="alternate" type="application/rss+xml" title="SimpleBlog" href="../rss.xml" />
        
        <script src="../js/jquery.min.js" type="text/javascript"></script>
        <script src="../js/jquery.flot.min.js" type="text/javascript"></script>
        

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-37082285-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
    </head>
    <body>

    <div id="page-wrap">
        <div id="header">
            <h1>&nbsp;</h1>
        </div>
        <div id="navigation">
             <a href="../">Home</a>
             <a href="../posts.html">All posts</a>
        </div>
        <div id="content">
<article>

<h1>C64jasm - a new take on C64 macro assembling</h1>

<p class="post-author">Janne Hellsten on November  8, 2018</p>

<h3 id="introduction">Introduction</h3>
<p>For the past couple of months I’ve worked on the C64 <a href="https://csdb.dk/release/?id=171134">VISIO 2018 invitation intro</a> (YouTube capture at the bottom of this post). I upped the difficulty level a bit by first designing and implementing a new 6502 macro assembler called <a href="https://github.com/nurpax/c64jasm">c64jasm</a>, and then using that to develop my demo. While I haven’t had the time to polish the assembler to, say, KickAssembler level, my tool turned out to be a real joy to work with. This post highlights some of its features that I believe make it somewhat unique in its small niche.</p>
<p>These were my initial design choices for c64jasm:</p>
<ul>
<li>Written in TypeScript &amp; running on Node. Easy multi-platform environment with easy to install dependencies.</li>
<li>Ability to extend the assembler’s functionality by calling into user-defined JavaScript modules directly from the .asm source.</li>
<li>A sufficiently powerful pseudo language (macros, conditionals, for-loops, etc) but build on the JavaScript extension mechanism for more complex pseudo ops like LUT creation and file format parsing.</li>
<li>Node-style “watch” support: automatically recompile if any source files change. Design it for efficiency.</li>
<li>VSCode integration (for on-the-fly compilation and error reporting within the IDE, launch output binary in VICE.)</li>
</ul>
<p>The choice of TypeScript was very deliberate. I’ve been meaning to learn the language for quite some time, and developing a macro assembler in it was a good way to learn &amp; evaluate TypeScript. TypeScript turned out to be a great language: supports functional programming style well (and so well-suited for developing compilers) and has a simple but powerful static typing system.</p>
<p>The assembler extension mechanism is the main feature that differentiates c64jasm from traditional 6502 macro assemblers and I’ll spend the rest of this blog talking about this mechanism.</p>
<p>This blog post assumes that you’re at least somewhat familiar with macro assemblers and that you know a bit of JavaScript.</p>
<h3 id="why-do-i-need-to-extend-my-assembler">Why do I need to extend my assembler?</h3>
<p>So why does one need to extend the assembler in the first place? I have my assembly, macros and other pseudo directives, isn’t this enough? Well, you need all of these too. But some things like loading graphics files, generating lookup tables, etc. can be better expressed in a real programming language. Quite commonly a demo project is built using a build script that processes LUTs, graphics, and other assets into hex listings to be included in the main assembly source.</p>
<h3 id="extending-functionality">Extending functionality</h3>
<p>Traditionally, extending the functionality of an application or a tool means that you’d first need to learn the app’s extension API, figure out how to build your extension (say .DLLs or a Java .jar file), install it (and maybe debug your PATH or CLASSPATH when it fails to load), and once all done, the feature becomes available in your tool and you use it to develop your content.</p>
<p>The approach I took in c64jasm is that assembler extensions are just a bunch of source files in your project’s source directory. Extensions shouldn’t require a separate build or installation step and the overhead of creating a new one for any specific purpose should be minimal. Ideally the extensions should be runnable stand-alone without the assembler and that you should be able to debug and test them using standard debugging tools.</p>
<p>Before we get deeper into c64jasm assembler plugins, let’s review some of the c64jasm pseudo directives.</p>
<h3 id="c64jasm-pseudo-ops">C64jasm pseudo ops</h3>
<p>If you’ve used something like KickAssembler, ACME or 64tass, these should look pretty familiar.</p>
<p>Declaring pseudo variables: You can declare pseudo variables using <code>!let</code>. This is basically the same as KickAssembler’s <code>.const</code>/<code>.var</code> (many other assemblers commonly have this as <code>EQU</code>.)</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">; declaring variables</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>!let after_bounce_frames <span class="op">=</span> <span class="dv">64</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>!let sprite_writer_path_tablen <span class="op">=</span> <span class="dv">128</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co">; assigning a new value to a previously declared variable</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>after_bounce_frames <span class="op">=</span> <span class="dv">33</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co">; using the variables in immediates</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    sec</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    sbc <span class="op">#</span>sprite_writer_path_tablen</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">cmp</span> <span class="op">#</span>after_bounce_frames</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    bcs do_wrap</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">jmp</span> no_wrap</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">do_wrap:</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">jmp</span> wrap</span></code></pre></div>
<p>Macros:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">some_mem_loc:</span> !<span class="dt">byte</span> <span class="dv">0</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">; declare a macro to write an immediate value to memory</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>!<span class="pp">macro</span> mov8imm<span class="op">(</span>d<span class="op">,</span> imm<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    lda <span class="op">#</span>imm</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    sta d<span class="op">+</span><span class="dv">0</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co">; expand the macro</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>+mov8imm<span class="op">(</span>some_mem_loc<span class="op">,</span> <span class="op">#$</span><span class="bn">80</span><span class="op">)</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co">; this will emit the following code:</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co">;</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co">;    lda #$80</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co">;    sta some_mem_loc</span></span></code></pre></div>
<p>Symbols declared within a macro are local to that macro. You can also declare macros within macros.</p>
<p>If/elif/else:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>!let double_y <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>!<span class="pp">if</span> <span class="op">(</span>double_y<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    ldy <span class="op">#</span>yy<span class="op">*</span><span class="dv">6</span><span class="op">+</span><span class="dv">1</span>         <span class="co">; code from this path</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    sta <span class="op">(</span>zpdst_even<span class="op">),</span>y  <span class="co">; will be emitted</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    sta <span class="op">(</span>zpdst_odd<span class="op">),</span>y</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    txa</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    dey</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    sta <span class="op">(</span>zpdst_even<span class="op">),</span>y</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    sta <span class="op">(</span>zpdst_odd<span class="op">),</span>y</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="pp">else</span> <span class="op">{</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    ldy <span class="op">#</span>yy<span class="op">*</span><span class="dv">3</span><span class="op">+</span><span class="dv">1</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    sta <span class="op">(</span>zpdst_even<span class="op">),</span>y</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    txa</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    dey</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    sta <span class="op">(</span>zpdst_even<span class="op">),</span>y</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>For-loops:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">; emit 8 nops</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>!for i in range<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">8</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">nop</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>As opposed to a C-style “declare loop variable, check condition, increment” for loops, c64jasm’s <code>for</code> is similar to Python’s for-statement. You use a function called <code>range()</code> that returns a list of integers and the for-loop just iterates over the elements of this list, assigning the current list element to the bound loop variable <code>i</code>. E.g., these two are conceptually the same:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">; emit four NOPs</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>!for i in range<span class="op">(</span><span class="dv">4</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">nop</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>!for i in <span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">3</span><span class="op">]</span> <span class="op">{</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">nop</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>The “emit byte” pseudo <code>!byte</code> supports emitting a list of bytes when passed an integer list. The following two lines are equivalent:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>!<span class="dt">byte</span> range<span class="op">(</span><span class="dv">4</span><span class="op">)</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>!<span class="dt">byte</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span></span></code></pre></div>
<h3 id="c64jasm-extensions">C64jasm extensions</h3>
<p>So with the basic c64jasm pseudo ops explained, let’s continue to c64jasm extensions. A c64jasm extension is just a JavaScript .js module. To use such a .js module in your assembly source, you bind it to a name with <code>!use "path/to/plugin.js"</code>. This name becomes a function that you can call in your assembly source file.</p>
<p>Let’s illustrate this with some code to generate a sine lookup table. First the plugin code:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a># sintab<span class="op">.</span><span class="at">js</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>module<span class="op">.</span><span class="at">exports</span> <span class="op">=</span> ({}<span class="op">,</span> len<span class="op">,</span> scale) <span class="kw">=&gt;</span> {</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> res <span class="op">=</span> <span class="bu">Array</span>(len)<span class="op">.</span><span class="fu">fill</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">map</span>((v<span class="op">,</span>i) <span class="kw">=&gt;</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">sin</span>(i<span class="op">/</span>len <span class="op">*</span> <span class="bu">Math</span><span class="op">.</span><span class="cn">PI</span> <span class="op">*</span> <span class="fl">2.0</span>) <span class="op">*</span> scale)<span class="op">;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> res<span class="op">;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Here’s how you’d use the above in your .asm source file:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">; Bind sintab.js default export to a pseudo function 'mkSintab'</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>!use <span class="st">&quot;./sintab&quot;</span> as mkSintab</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>!let sin1scale <span class="op">=</span> <span class="dv">26</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="fu">sintab1:</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>!for s in mkSintab<span class="op">(</span><span class="dv">256</span><span class="op">,</span> sin1scale<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    !<span class="dt">byte</span> s</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>As <code>!byte</code> and <code>!word</code> accept a list as an argument, the above can be written simply as:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sintab1:</span> !<span class="dt">byte</span> mkSintab<span class="op">(</span><span class="dv">256</span><span class="op">,</span> sin1scale<span class="op">)</span></span></code></pre></div>
<p>The nice thing about this approach is that I can keep the assembler implementation simple. The assembler doesn’t need a large standard library of math and other utility functions as this functionality can be easily expressed as tiny JavaScript modules.</p>
<p>Sure, generating a sine table would be pretty easy without an extension too (and this is totally supported by c64jasm):</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sintab1:</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>   !for s in range<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">256</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>       !<span class="dt">byte</span> sin<span class="op">(</span>s<span class="op">/</span><span class="dv">256</span><span class="op">*</span><span class="dv">2</span><span class="op">*</span>PI<span class="op">)*</span>scl</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>   <span class="op">}</span></span></code></pre></div>
<p>Where I find the JavaScript extension mechanism really shines is importing assets (sprites from .spd, .sid, etc.). Here’s how I compile SpritePad .spd files into my demo binary:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a># spd<span class="op">.</span><span class="at">js</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>module<span class="op">.</span><span class="at">exports</span> <span class="op">=</span> ({readFileSync<span class="op">,</span> resolveRelative}<span class="op">,</span> filename) <span class="kw">=&gt;</span> {</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> buf <span class="op">=</span> <span class="fu">readFileSync</span>(<span class="fu">resolveRelative</span>(filename))<span class="op">;</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> numSprites <span class="op">=</span> buf<span class="op">.</span><span class="fu">readUInt8</span>(<span class="dv">4</span>)<span class="op">+</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> data <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> numSprites<span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> offs <span class="op">=</span> i<span class="op">*</span><span class="dv">64</span><span class="op">+</span><span class="dv">9</span><span class="op">;</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> bytes <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (<span class="kw">let</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> <span class="dv">64</span><span class="op">;</span> j<span class="op">++</span>) {</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>            bytes<span class="op">.</span><span class="fu">push</span>(buf<span class="op">.</span><span class="fu">readUInt8</span>(offs <span class="op">+</span> j))<span class="op">;</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>        data<span class="op">.</span><span class="fu">push</span>(bytes)<span class="op">;</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>        numSprites<span class="op">,</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>        <span class="dt">enableMask</span><span class="op">:</span> (<span class="dv">1</span><span class="op">&lt;&lt;</span>numSprites)<span class="op">-</span><span class="dv">1</span><span class="op">,</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>        <span class="dt">bg</span><span class="op">:</span> buf<span class="op">.</span><span class="fu">readUInt8</span>(<span class="dv">6</span>)<span class="op">,</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>        <span class="dt">multicol1</span><span class="op">:</span> buf<span class="op">.</span><span class="fu">readUInt8</span>(<span class="dv">7</span>)<span class="op">,</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>        <span class="dt">multicol2</span><span class="op">:</span> buf<span class="op">.</span><span class="fu">readUInt8</span>(<span class="dv">8</span>)<span class="op">,</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>        data</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Using the above in an .asm file:</p>
<pre><code>!use &quot;./spd&quot; as spd

; Load 'hirmu.spd' and store the returned JavaScript object in a
; variable called 'hirmu_sprite'
!let hirmu_sprite = spd(&quot;../sprites/hirmu.spd&quot;)</code></pre>
<p>At this point, no code or bytes were yet emittted. The .spd file contents are now in a pseudo variable called <code>hirmu_sprite</code>. This is just a JavaScript object with fields like <code>numSprites</code>, <code>enableMask</code>, <code>data</code> that can be accessed from .asm with the dot operator (e.g., <code>sprite_data.numSprites</code>.)</p>
<p>With this, I can expand the sprite data into the output binary. Or I can use to emit code to setup sprite registers (enable bits, individual and multi color values, etc).</p>
<p>Emitting actual sprite data for all the sprites contained within the .spd file:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hirmu_sprite_data:</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">; loop over all the sprites in hirmu_sprite.data</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    !for sdata in hirmu_sprite<span class="op">.</span>data <span class="op">{</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>        !<span class="dt">byte</span> sdata  <span class="co">; expand 64 bytes of sprite data (one sprite)</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">; or equivalently:</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">; !for sidx in range(hirmu_sprite.numSprites) {</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">;    !byte hirmu_sprite.data[sidx]  ; expand 64 bytes of sprite data (one sprite)</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">; }</span></span></code></pre></div>
<p>I also define a macro that expands machine code to write sprite registers based on the .spd file contents:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>!<span class="pp">macro</span> set_sprite<span class="op">(</span>s<span class="op">,</span> <span class="dt">ptr</span><span class="op">,</span> xScale<span class="op">,</span> yScale<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    !<span class="pp">if</span> <span class="op">(</span>xScale <span class="op">==</span> <span class="dv">2</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>        lda <span class="op">#</span>s<span class="op">.</span>enableMask</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="pp">else</span> <span class="op">{</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>        lda <span class="op">#</span><span class="dv">0</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    sta <span class="op">$</span>d01d  <span class="co">; XSCALE register</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    !<span class="pp">if</span> <span class="op">(</span>yScale <span class="op">==</span> <span class="dv">2</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>        lda <span class="op">#</span>s<span class="op">.</span>enableMask</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="pp">else</span> <span class="op">{</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>        lda <span class="op">#</span><span class="dv">0</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    sta <span class="op">$</span>d017  <span class="co">; YSCALE register</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">; set sprite pointers and individual sprite colors for</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">; all sprites</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    !for sprite_idx in range<span class="op">(</span><span class="dv">0</span><span class="op">,</span> s<span class="op">.</span>numSprites<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">; load the individual color from sprite data</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>        lda <span class="op">#</span>s<span class="op">.</span>data<span class="op">[</span>sprite_idx<span class="op">][</span><span class="dv">63</span><span class="op">]</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">; indiv sprite color</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>        sta <span class="op">$</span>d027 <span class="op">+</span> sprite_idx</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>        lda <span class="op">#</span>ptr<span class="op">/</span><span class="dv">64</span> <span class="op">+</span> sprite_idx</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>        sta <span class="op">$</span><span class="bn">7f8</span> <span class="op">+</span> sprite_idx</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">; enable multicolor for the same sprites, set multicolor values</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>    lda <span class="op">#</span>s<span class="op">.</span>multicol1</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>    sta <span class="op">$</span>d025</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>    lda <span class="op">#</span>s<span class="op">.</span>multicol2</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>    sta <span class="op">$</span>d026</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">; enable all the sprites that were loaded from the .spd</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>    lda <span class="op">#</span>s<span class="op">.</span>enableMask</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>    sta <span class="op">$</span>d01c       <span class="co">; multicolor enable</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>    sta <span class="op">$</span>d015       <span class="co">; sprite enable</span></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a><span class="fu">set_hirmu_sprite:</span> <span class="op">{</span></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>    +set_sprite<span class="op">(</span>hirmu_sprite<span class="op">,</span> hirmu_sprite_data<span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">2</span><span class="op">)</span></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>    rts</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>I use the same pattern for all the different asset types used in my demo. Here’s how I pull the SID tune into the binary:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a># sid<span class="op">.</span><span class="at">js</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">readWord</span>(buf<span class="op">,</span> offs) {</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> buf<span class="op">.</span><span class="fu">readUInt8</span>(offs) <span class="op">+</span> (buf<span class="op">.</span><span class="fu">readUInt8</span>(offs<span class="op">+</span><span class="dv">1</span>) <span class="op">&lt;&lt;</span> <span class="dv">8</span>)<span class="op">;</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Read a big-endian word</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">readWordBE</span>(buf<span class="op">,</span> offs) {</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (buf<span class="op">.</span><span class="fu">readUInt8</span>(offs)<span class="op">&lt;&lt;</span><span class="dv">8</span>) <span class="op">+</span> buf<span class="op">.</span><span class="fu">readUInt8</span>(offs<span class="op">+</span><span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>module<span class="op">.</span><span class="at">exports</span> <span class="op">=</span> ({readFileSync<span class="op">,</span> resolveRelative}<span class="op">,</span> filename) <span class="kw">=&gt;</span> {</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> buf <span class="op">=</span> <span class="fu">readFileSync</span>(<span class="fu">resolveRelative</span>(filename))<span class="op">;</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> version <span class="op">=</span> <span class="fu">readWordBE</span>(buf<span class="op">,</span> <span class="dv">4</span>)<span class="op">;</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> dataOffset <span class="op">=</span> <span class="fu">readWordBE</span>(buf<span class="op">,</span> <span class="dv">6</span>)<span class="op">;</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> startAddress <span class="op">=</span> <span class="fu">readWord</span>(buf<span class="op">,</span> dataOffset)<span class="op">;</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> init <span class="op">=</span> <span class="fu">readWordBE</span>(buf<span class="op">,</span> <span class="bn">0x0a</span>)<span class="op">;</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> play <span class="op">=</span> <span class="fu">readWordBE</span>(buf<span class="op">,</span> <span class="bn">0x0c</span>)<span class="op">;</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> numSongs <span class="op">=</span> <span class="fu">readWord</span>(buf<span class="op">,</span> <span class="bn">0x0e</span>)<span class="op">;</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> res <span class="op">=</span> {</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>        startAddress<span class="op">,</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>        <span class="dt">data</span><span class="op">:</span> [<span class="op">...</span>buf<span class="op">.</span><span class="fu">slice</span>(dataOffset<span class="op">+</span><span class="dv">2</span>)]<span class="op">,</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>        <span class="dt">init</span><span class="op">:</span> startAddress<span class="op">,</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>        <span class="dt">play</span><span class="op">:</span> startAddress <span class="op">+</span> <span class="dv">3</span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> res<span class="op">;</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Using the loaded SID tune from the .asm source:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>!use <span class="st">&quot;./sid&quot;</span> as sid</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>!let music <span class="op">=</span> sid<span class="op">(</span><span class="st">&quot;sid/tune.sid&quot;</span><span class="op">)</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="fu">demo_start:</span> <span class="op">{</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    lda <span class="op">#</span><span class="dv">0</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    jsr music<span class="op">.</span>init</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    ...</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    jsr music<span class="op">.</span>play      <span class="co">; usually called from an IRQ</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>* = music<span class="op">.</span>startAddress  <span class="co">; usually music.startAddress == $1000</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="fu">music:</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>!<span class="dt">byte</span> music<span class="op">.</span>data</span></code></pre></div>
<p>All of these content plugins are just normal .js files that can be run from the command line with <code>node</code>. This enables you to use standard tools like VSCode to debug them as stand-alone JavaScript modules. I prefer this code to be part of the project source tree rather than buried somewhere within c64jasm’s standard libraries.</p>
<h3 id="epilogue">Epilogue</h3>
<p>OK, that’s about it for now on c64jasm plugins. I will probably write another blog later about using c64jasm in VSCode (with quick re-compile-on-save and launch .prg in VICE.) I <a href="https://twitter.com/nurpax/status/1049757222547451906">tweeted</a> about it a while ago, you can check out the video if you’re curious about this.</p>
<p>Oh by the way, <a href="https://github.com/nurpax/c64jasm">c64jasm</a> is available on GitHub and is already quite usable. However, it’s still very much work-in-progress. If you’re into this type of stuff and feeling adventurous, feel free to give it a try. Otherwise, stick with the more established C64 assemblers. :)</p>
<h3 id="visio-2018-invitation-demo-capture">VISIO 2018 invitation demo capture</h3>
<div class="youtube">
<iframe class="video" src="https://www.youtube.com/embed/Jr5DqTcFpf4?rel=0&amp;controls=1&amp;showinfo=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen>
</iframe>
</div>


</article>


        </div>
        <div id="footer">
          <p>Like what you saw here?  Suggestions, improvements?</p>
          <p>Get in touch: jjhellst@gmail.com or <a href="https://twitter.com/nurpax">@nurpax</a></p>
        </div>
    </div>


    </body>
</html>
